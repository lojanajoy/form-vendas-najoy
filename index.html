<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Formulário de Vendas - NAJOY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Mantém seu CSS original -->
  <style>
    /* ... todo o CSS original que você já tinha ... */
  </style>
</head>
<body>
  <div class="form-wrapper">
    <header>
      <div class="brand-block">
        <div class="brand-name">NAJOY</div>
        <div class="brand-subtitle">Lingeries &amp; Sensualidade</div>
      </div>
      <div class="header-info">
        <div>Formulário interno de registro de vendas</div>
        <div><a href="https://www.lojanajoy.com.br" target="_blank" rel="noopener noreferrer">lojanajoy.com.br</a></div>
      </div>
    </header>
    <h1>Registro de venda</h1>
    <form id="form-venda">
      <!-- DADOS GERAIS -->
      <!-- Mantém a primeira seção igual -->
      
      <!-- PRODUTOS -->
      <section class="card">
        <div class="products-header">
          <div class="section-title">Produtos</div>
          <p>Adicione todos os itens da venda. Use o botão “+ produto” para incluir novos.</p>
        </div>
        <div id="products-list"></div>
        <div class="field" style="margin-top:10px; max-width:230px; margin-left:auto;">
          <label for="valor-total">Valor total da venda</label>
          <input type="text" id="valor-total" name="valor_total" readonly placeholder="R$ 0,00">
          <span class="field-helper">Calculado automaticamente pelos produtos.</span>
        </div>
        <div class="products-actions">
          <button type="button" class="btn-icon" id="btn-add-product">
            <span class="symbol">+ </span> produto
          </button>
        </div>
      </section>

      <!-- ENTREGA, PAGAMENTO, ORIGEM, CANAL & OBSERVAÇÕES -->
      <section class="card">
        <div class="section-title">Entrega &amp; detalhes</div>
        <div class="footer-grid">
          <!-- campos já existentes -->
        </div>

        <!-- Campo Canal da venda -->
        <div class="field" style="margin-top:14px;">
          <label for="canal-venda">Canal da venda<span class="required">*</span></label>
          <select id="canal-venda" name="canal_venda" required>
            <option value="">Selecione...</option>
            <option value="site">Site</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div class="field" id="canal-outros-wrapper" style="margin-top:10px; display:none;">
          <label for="canal-outros">Informe o canal (Outros)</label>
          <input type="text" id="canal-outros" name="canal_outros" placeholder="Digite o canal">
        </div>

      </section>

      <!-- AÇÕES -->
      <div class="actions">
        <button type="reset" class="btn-secondary">limpar</button>
        <button type="submit" class="btn-main">registrar venda</button>
      </div>
      <p class="required-note">Campos marcados com <span class="asterisk">*</span> são obrigatórios.</p>
      <div id="feedback" class="feedback"></div>
    </form>
  </div>

  <script>
    const WEB_APP_URL = "SUA_URL_DO_APP_SCRIPT_AQUI";
    const productsList = document.getElementById('products-list');
    const addProductBtn = document.getElementById('btn-add-product');
    const totalInput = document.getElementById('valor-total');

    // selects "Outros"
    const entregaSelect = document.getElementById('tipo-entrega');
    const entregaOutrosWrapper = document.getElementById('entrega-outros-wrapper');
    const entregaOutrosInput = document.getElementById('entrega-outros');
    const formaPagamentoSelect = document.getElementById('forma-pagamento');
    const pagamentoOutrosWrapper = document.getElementById('pagamento-outros-wrapper');
    const pagamentoOutrosInput = document.getElementById('pagamento-outros');
    const origemSelect = document.getElementById('origem-cliente');
    const origemOutrosWrapper = document.getElementById('origem-outros-wrapper');
    const origemOutrosInput = document.getElementById('origem-outros');

    // Novo: canal da venda
    const canalVendaSelect = document.getElementById('canal-venda');
    const canalOutrosWrapper = document.getElementById('canal-outros-wrapper');
    const canalOutrosInput = document.getElementById('canal-outros');

    canalVendaSelect.addEventListener('change', () => {
      if (canalVendaSelect.value === 'outros') {
        canalOutrosWrapper.style.display = 'block';
      } else {
        canalOutrosWrapper.style.display = 'none';
        canalOutrosInput.value = '';
      }
    });

    function createProductItem() {
      const index = productsList.children.length;
      const wrapper = document.createElement('div');
      wrapper.className = 'product-item';
      wrapper.innerHTML = `
        <div class="field">
          <span class="pill-label">Categoria<span class="required">*</span></span>
          <select data-role="categoria" name="produtos[${index}][categoria]" required>
            <option value="">Selecione...</option>
            <option value="lingeries">Lingeries</option>
            <option value="sexy-shop">Sexy shop</option>
            <option value="acessorios">Acessórios</option>
            <option value="calcinhas">Calcinhas</option>
            <option value="outros">Outros</option>
          </select>
        </div>
        <div class="field">
          <span class="pill-label">Quantidade<span class="required">*</span></span>
          <input type="number" min="1" data-role="quantidade" name="produtos[${index}][quantidade]" placeholder="1" required>
        </div>
        <div class="field">
          <span class="pill-label">Nome do produto<span class="required">*</span></span>
          <input type="text" data-role="nome" name="produtos[${index}][nome]" placeholder="Ex.: Conjunto renda" required>
        </div>
        <div class="field">
          <span class="pill-label">Tamanho</span>
          <input type="text" data-role="tamanho" name="produtos[${index}][tamanho]" placeholder="Ex.: P, M, G, GG">
        </div>
        <div class="field">
          <span class="pill-label">Cor</span>
          <input type="text" data-role="cor" name="produtos[${index}][cor]" placeholder="Ex.: vermelho, preto">
        </div>
        <div class="field">
          <span class="pill-label">Valor (R$)<span class="required">*</span></span>
          <input type="number" step="0.01" min="0" inputmode="decimal" data-role="valor" name="produtos[${index}][valor]" placeholder="0,00" required>
        </div>
        <div class="btn-row">
          <button type="button" class="btn-icon btn-icon--ghost btn-remove-product">remover</button>
        </div>
        <div class="field field--full product-cat-outros" style="display:none; margin-top:6px;">
          <span class="pill-label">Informe a categoria (Outros)</span>
          <input type="text" data-role="categoria_outros" name="produtos[${index}][categoria_outros]" placeholder="Digite a categoria do produto">
        </div>
      `;
      const removeBtn = wrapper.querySelector('.btn-remove-product');
      removeBtn.addEventListener('click', () => {
        productsList.removeChild(wrapper);
        renumberProducts();
        updateTotal();
      });
      const valorInput = wrapper.querySelector("input[data-role='valor']");
      valorInput.addEventListener('input', updateTotal);
      // categoria outros
      const categoriaSelect = wrapper.querySelector("select[data-role='categoria']");
      const catOutrosWrapper = wrapper.querySelector('.product-cat-outros');
      const catOutrosInput = wrapper.querySelector("input[data-role='categoria_outros']");
      categoriaSelect.addEventListener('change', () => {
        if (categoriaSelect.value === 'outros') {
          catOutrosWrapper.style.display = 'block';
        } else {
          catOutrosWrapper.style.display = 'none';
          catOutrosInput.value = '';
        }
      });
      return wrapper;
    }

    function renumberProducts() {
      Array.from(productsList.children).forEach((item, newIndex) => {
        item.querySelectorAll('[name]').forEach(el => {
          const role = el.getAttribute('data-role');
          if (role) {
            el.name = `produtos[${newIndex}][${role}]`;
          }
        });
      });
    }

    function updateTotal() {
      let total = 0;
      Array.from(productsList.children).forEach(item => {
        const valInput = item.querySelector("input[data-role='valor']");
        if (!valInput) return;
        let v = valInput.value.trim();
        if (!v) return;
        v = v.replace(',', '.'); // corrige centavos
        const num = parseFloat(v);
        if (!isNaN(num)) {
          total += num;
        }
      });
      if (total > 0) {
        totalInput.value = "R$ " + total.toFixed(2).replace('.', ',');
      } else {
        totalInput.value = "";
      }
    }

    addProductBtn.addEventListener('click', () => {
      productsList.appendChild(createProductItem());
    });
    if (productsList.children.length === 0) {
      productsList.appendChild(createProductItem());
    }

    // selects outros para entrega/pagamento/origem
    entregaSelect.addEventListener('change', () => {
      entregaOutrosWrapper.style.display = entregaSelect.value === 'outros' ? 'block' : 'none';
      if (entregaSelect.value !== 'outros') entregaOutrosInput.value = '';
    });
    formaPagamentoSelect.addEventListener('change', () => {
      pagamentoOutrosWrapper.style.display = formaPagamentoSelect.value === 'outros' ? 'block' : 'none';
      if (formaPagamentoSelect.value !== 'outros') pagamentoOutrosInput.value = '';
    });
    origemSelect.addEventListener('change', () => {
      origemOutrosWrapper.style.display = origemSelect.value === 'outros' ? 'block' : 'none';
      if (origemSelect.value !== 'outros') origemOutrosInput.value = '';
    });

    // envio para planilha
    const form = document.getElementById('form-venda');
    const feedbackEl = document.getElementById('feedback');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      const formData = new FormData(form);
      const plainData = Object.fromEntries(formData.entries());

      // produtos
      const produtos = [];
      Array.from(productsList.children).forEach((item) => {
        const p = {};
        item.querySelectorAll('[data-role]').forEach(el => {
          p[el.getAttribute('data-role')] = el.value;
        });
        produtos.push(p);
      });
      plainData.produtos = produtos;

      // total
      plainData.total = totalInput.value || "";

      try {
        feedbackEl.textContent = "Enviando registro para a planilha...";
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(plainData)
        });
        feedbackEl.textContent = "Venda registrada com sucesso!";
        feedbackEl.classList.add("success");
        form.reset();
        productsList.innerHTML = "";
        productsList.appendChild(createProductItem());
        updateTotal();
        entregaOutrosWrapper.style.display = 'none';
        pagamentoOutrosWrapper.style.display = 'none';
        origemOutrosWrapper.style.display = 'none';
        canalOutrosWrapper.style.display = 'none';
      } catch (error) {
        console.error(error);
        feedbackEl.textContent = "Ocorreu um erro ao enviar para a planilha.";
        feedbackEl.classList.add("error");
      }
    });
  </script>
</body>
</html>
